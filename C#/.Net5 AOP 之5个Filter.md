# .Net Core之五大Filter

AOP:在不修改原有代码的前提下，动态增加新的功能；

- AuthorizationFilter 鉴权授权
- ResourceFilter 资源
- ExceptionFilter  异常
- ActionFilter   方法
- ResultFilter  结果过滤

# ActionFilter

##  实现IActionFilter

可以标记在Action或控制器上 

public class MyActionFilterAttribute : Attribute, IActionFilter，

执行步骤：

- controller 构造函数
- MyActionFilterAttribute --->OnActionExecuting  方法执行前
- AOP切面：执行方法前
- 执行Action
- AOP切面：执行方法后
- MyActionFilterAttribute --->OnActionExecuted   方法执行后

## 实现ActionFilterAttribute 

## 应用

- 日志记录

- Filter的多种注册和扩展

  - [myFilter.MyActionFilter]// 必须有 无参构造器

  - [TypeFilter(typeof(myFilter.MyActionFilterAttribute))]//可以没有无参构造器，支持依赖注入

  - [ServiceFilter(typeof(myFilter.MyActionFilterAttribute))]//可以没有无参构造器，支持依赖注入，但必须要注册服务

    containerBuilder.RegisterType(typeof(MyActionFilterAttribute)).PropertiesAutowired();//支持属性注入

- IFilterFactory 扩展定制  ---需要IOC容器配合完成  容器中注入

  [MyFilterFactory(typeof(MyActionFilterAttribute))]

```c#
 public class MyFilterFactoryAttribute : Attribute, IFilterFactory
    {
        private readonly Type _Type = null;

        public MyFilterFactoryAttribute(Type type)
        {
            _Type = type;
        }

        public IFilterMetadata CreateInstance(IServiceProvider serviceProvider)
        {
            var obj = serviceProvider.GetService(_Type);

            return (IFilterMetadata) obj;
        }

        public bool IsReusable => true;
    }
```

## 作用范围、执行顺序

```c#
 //全局注册过滤器
services.AddMvc(opt =>
                {
                    opt.Filters.Add<MyActionFilterAttribute>();
                });
```

执行顺序：可以通过Order 进行控制 从小到大；

- 控制器构造函数
- 全局OnActionExecuting  
  - 控制器OnActionExecuting  
    - 方法OnActionExecuting  
      - 执行方法（action）
    - 方法OnActionExecuted 
  - 控制器OnActionExecuted   
- 全局OnActionExecuted   

# ResourceFilter

适合做缓存，只要对 context.Result 进行了赋值，就不往下走，直接返回；

![](异步编程/img/Filter执行顺序.png)